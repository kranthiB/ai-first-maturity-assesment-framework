{% extends "base/layout.html" %}
{% set page_title = "Assessment Report" %}
{% set show_breadcrumbs = true %}
{% set breadcrumbs = [
    {"name": "Home", "url": url_for('main.index') if url_for else '/'},
    {"name": "Assessment", "url": url_for('assessment.index') if url_for else '/assessment/'},
    {"name": "Report", "url": "#", "active": true}
] %}

{% block head_extra %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
.report-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    margin-bottom: 30px;
}

.score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.roadmap-card {
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.roadmap-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.roadmap-level {
    background: linear-gradient(45deg, #f8f9fa, #e9ecef);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
}

.roadmap-level.level-2 { border-left-color: #28a745; }
.roadmap-level.level-3 { border-left-color: #ffc107; }
.roadmap-level.level-4 { border-left-color: #dc3545; }

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.insight-card {
    border-radius: 12px;
    border: none;
    margin-bottom: 15px;
    overflow: hidden;
}

.insight-card.strength { background: linear-gradient(45deg, #d4edda, #c3e6cb); }
.insight-card.improvement { background: linear-gradient(45deg, #f8d7da, #f5c6cb); }
.insight-card.warning { background: linear-gradient(45deg, #fff3cd, #ffeaa7); }
.insight-card.success { background: linear-gradient(45deg, #d1ecf1, #bee5eb); }

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.roadmap-header {
    background: linear-gradient(45deg, #6c5ce7, #a29bfe);
    color: white;
    padding: 15px 20px;
    border-radius: 12px 12px 0 0;
    margin: -20px -20px 20px -20px;
}

.progress-indicator {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.progress-step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-weight: bold;
    color: white;
}

.progress-step.current { background: #007bff; }
.progress-step.next { background: #28a745; }
.progress-step.future { background: #6c757d; }

.roadmap-section {
    margin-bottom: 30px;
}

.action-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 8px;
    border-left: 3px solid #007bff;
}

.metric-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.maturity-breakdown-card {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.maturity-breakdown-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.fade-in {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s ease;
}

.fade-in.animate {
    opacity: 1;
    transform: translateY(0);
}

.chart-placeholder {
    width: 100%;
    height: 300px;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
}

.btn-download-pdf {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 12px 30px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.btn-download-pdf:hover {
    background: linear-gradient(135deg, #218838 0%, #1ead8a 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    color: white;
    text-decoration: none;
}

.btn-download-pdf:focus {
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25);
    color: white;
    text-decoration: none;
}

.btn-download-pdf:active {
    transform: translateY(0);
}

.btn-download-pdf::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn-download-pdf:hover::before {
    left: 100%;
}

.btn-download-pdf i {
    font-size: 1.2rem;
    margin-right: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Report Header -->
    <div class="report-header p-4 mb-4 fade-in">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="fw-bold mb-3">
                    <i class="bi bi-graph-up me-3"></i>AI-First Maturity Assessment Report
                </h1>
                <h2 class="mb-3">{{ organization_name }}</h2>
                <div class="d-flex flex-wrap gap-3 mb-3">
                    <span class="badge bg-light text-dark px-3 py-2">
                        <i class="bi bi-calendar-check me-2"></i>Completed: {{ completion_date.strftime('%B %d, %Y') if completion_date else 'N/A' }}
                    </span>
                    <span class="badge bg-light text-dark px-3 py-2">
                        <i class="bi bi-clipboard-data me-2"></i>{{ responses_count }}/{{ total_questions }} Questions
                    </span>
                </div>
                <div class="mb-4">
                    <a href="{{ url_for('assessment.download_pdf', assessment_id=assessment.id) }}" 
                       class="btn-download-pdf" target="_blank">
                        <i class="bi bi-download me-2"></i>Download PDF Report
                    </a>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="score-circle mx-auto mb-3">
                    <div class="text-center">
                        <div class="fw-bold" style="font-size: 2.5rem;">{{ "%.1f"|format(overall_score) }}</div>
                        <div class="fw-semibold">Overall Score</div>
                    </div>
                </div>
                <h4 class="fw-bold">{{ overall_level }}</h4>
                <p class="mb-0">Current Maturity Level</p>
            </div>
        </div>
    </div>

    <!-- Organizational Information Row -->
    {% set has_org_info = assessment.first_name or assessment.last_name or assessment.email or assessment.assessor_name or assessment.account_name %}
    {% if has_org_info %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm fade-in">
                <div class="card-body">
                    <div class="row">
                        {% if assessment.first_name or assessment.last_name %}
                        <div class="col-md-6 col-lg-3 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="bi bi-person me-2"></i>Contact Person
                            </h6>
                            <p class="mb-0 fw-semibold">
                                {{ assessment.first_name or '' }} {{ assessment.last_name or '' }}
                            </p>
                            {% if assessment.email %}
                            <small class="text-muted">
                                <i class="bi bi-envelope me-1"></i>{{ assessment.email }}
                            </small>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if assessment.team_name and assessment.team_name != organization_name %}
                        <div class="col-md-6 col-lg-3 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="bi bi-people me-2"></i>Team
                            </h6>
                            <p class="mb-0 fw-semibold">{{ assessment.team_name }}</p>
                        </div>
                        {% endif %}
                        
                        {% if assessment.assessor_name %}
                        <div class="col-md-6 col-lg-3 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="bi bi-clipboard-check me-2"></i>Assessor
                            </h6>
                            <p class="mb-0 fw-semibold">{{ assessment.assessor_name }}</p>
                            {% if assessment.assessor_email %}
                            <small class="text-muted">
                                <i class="bi bi-envelope me-1"></i>{{ assessment.assessor_email }}
                            </small>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if assessment.industry %}
                        <div class="col-md-6 col-lg-3 mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="bi bi-diagram-3 me-2"></i>Industry
                            </h6>
                            <p class="mb-0 fw-semibold">{{ assessment.industry | upper }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Key Metrics Row -->
    <div class="row mb-4 fade-in">
        {% for section in section_scores %}
        <div class="col-md-3 mb-3">
            <div class="metric-card">
                <div class="metric-icon" style="color: {{ section.color }};">
                    <i class="bi bi-pie-chart"></i>
                </div>
                <h3 class="fw-bold mb-2" style="color: {{ section.color }};">
                    {{ "%.1f"|format(section.score) }}
                </h3>
                <h6 class="text-muted mb-1">{{ section.name }}</h6>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar" 
                         style="width: {{ section.percentage }}%; background-color: {{ section.color }};">
                    </div>
                </div>
                <small class="text-muted">{{ section.percentage }}% of max</small>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Charts Row -->
                <!-- Charts Section -->
            <div class="row mt-5 mb-5">
                <div class="col-md-6 mb-5">
                    <div class="card shadow-sm fade-in">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-pie-chart me-2"></i>
                                Section Performance Overview
                            </h5>
                        </div>
                        <div class="card-body" style="height: 500px; position: relative; padding: 25px; margin-bottom: 20px;">
                            <p class="text-muted small mb-3">
                                <i class="bi bi-info-circle me-1"></i>
                                This chart shows your organization's performance across the four key AI maturity sections. 
                                Each section is scored from 0-4, with higher scores indicating greater maturity.
                            </p>
                            <div id="chartLoadingSection" class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading chart...</span>
                                </div>
                                <p class="mt-2">Loading section chart...</p>
                            </div>
                            <canvas id="sectionChart" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-5">
                    <div class="card shadow-sm fade-in">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-bar-chart me-2"></i>
                                Maturity Level Distribution
                            </h5>
                        </div>
                        <div class="card-body" style="height: 500px; position: relative; padding: 25px; margin-bottom: 20px;">
                            <p class="text-muted small mb-3">
                                <i class="bi bi-info-circle me-1"></i>
                                This chart displays how your responses are distributed across AI maturity levels. 
                                Each bar represents the number of <strong>sections</strong> that achieved that maturity level.
                                <strong>The numbers on the bars show how many sections (out of 4 total) are at each level.</strong>
                            </p>
                            <div id="chartLoadingMaturity" class="text-center p-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading chart...</span>
                                </div>
                                <p class="mt-2">Loading maturity chart...</p>
                            </div>
                            <canvas id="maturityChart" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Maturity Level Breakdown -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm fade-in">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>
                        Section Maturity Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        <i class="bi bi-info-circle me-1"></i>
                        Here's which specific sections achieved each maturity level:
                    </p>
                    
                    {% set maturity_levels = ['Traditional', 'AI-Assisted', 'AI-Augmented', 'AI-First'] %}
                    {% set level_colors = ['#6c757d', '#ffc107', '#28a745', '#dc3545'] %}
                    {% set level_icons = ['bi-archive', 'bi-gear', 'bi-lightning', 'bi-rocket-takeoff'] %}
                    
                    <div class="row">
                        {% for i in range(4) %}
                        {% set level = maturity_levels[i] %}
                        {% set color = level_colors[i] %}
                        {% set icon = level_icons[i] %}
                        {% set sections_at_level = [] %}
                        
                        {% for section in section_scores %}
                            {% if section.level == level %}
                                {% set _ = sections_at_level.append(section) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if sections_at_level %}
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="maturity-breakdown-card h-100" style="border-left: 4px solid {{ color }};">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi {{ icon }} me-2" style="color: {{ color }}; font-size: 1.2rem;"></i>
                                    <h6 class="mb-0 fw-bold">{{ level }}</h6>
                                    <span class="badge rounded-pill ms-auto" style="background-color: {{ color }};">{{ sections_at_level|length }}</span>
                                </div>
                                <ul class="list-unstyled mb-0 small">
                                    {% for section in sections_at_level %}
                                    <li class="mb-1">
                                        <i class="bi bi-check-circle-fill me-1" style="color: {{ color }}; font-size: 0.8rem;"></i>
                                        {{ section.name }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Row -->
    <div class="row mb-4 mt-5">
        <div class="col-12">
            <h4 class="fw-bold mb-4 fade-in" style="margin-top: 2rem;">
                <i class="bi bi-lightbulb me-2 text-warning"></i>
                Key Insights
            </h4>
            <div class="row">
                {% for insight in insights %}
                <div class="col-md-4 mb-3">
                    <div class="insight-card {{ insight.type }} p-4 fade-in">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-{{ insight.icon }} fs-3 me-3"></i>
                            <h6 class="mb-0 fw-bold">{{ insight.title }}</h6>
                        </div>
                        <p class="mb-0">{{ insight.description }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Priority Areas -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="fw-bold mb-4 fade-in">
                <i class="bi bi-target me-2 text-danger"></i>
                Priority Areas for Improvement
            </h4>
            <div class="row">
                {% for area in priority_areas %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100 fade-in">
                        <div class="card-header text-white" style="background: {{ area.color }};">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">#{{ area.rank }} Priority</h6>
                                <span class="badge bg-light text-dark">{{ area.level }}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="fw-bold">{{ area.name }}</h5>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Current Score:</span>
                                <span class="fw-bold fs-4" style="color: {{ area.color }};">
                                    {{ "%.1f"|format(area.score) }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Improvement Potential:</span>
                                <span class="fw-bold text-success">
                                    +{{ area.improvement_potential }} points
                                </span>
                            </div>
                            {% if area.areas %}
                            <h6 class="fw-bold mt-3 mb-2">Focus Areas:</h6>
                            <ul class="list-unstyled">
                                {% for sub_area in area.areas %}
                                <li class="mb-1">
                                    <small class="text-muted">
                                        {{ sub_area.name }} ({{ "%.1f"|format(sub_area.score) }})
                                    </small>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Roadmap Section -->
    <div class="row">
        <div class="col-12">
            <h2 class="fw-bold mb-4 fade-in">
                <i class="bi bi-map me-2 text-primary"></i>
                Personalized Maturity Roadmap
            </h2>
            <p class="lead text-muted mb-4 fade-in">
                Based on your responses, here's your step-by-step guide to advancing through maturity levels.
            </p>

            {% for question_id, roadmap in roadmap_data.items() %}
            <div class="roadmap-card fade-in">
                <div class="card-body p-4">
                    <div class="roadmap-header">
                        <h5 class="mb-2 fw-bold">
                            <i class="bi bi-question-circle me-2"></i>
                            {{ roadmap.area_name }}
                        </h5>
                        <p class="mb-0 opacity-75">{{ roadmap.question }}</p>
            {% if roadmap.notes %}
            <div class="mt-2">
                <span class="fw-bold" style="color: #ffffff;"><i class="bi bi-chat-text me-1"></i>Notes: <p class="mb-0 opacity-75">{{ roadmap.notes }}</p></span>
            </div>
            {% endif %}
                    </div>

                    <!-- Current Level -->
                    <div class="progress-indicator">
                        <div class="progress-step current">{{ roadmap.current_level }}</div>
                        <div>
                            <h6 class="mb-1 fw-bold">Current Level {{ roadmap.current_level }}</h6>
                            <p class="text-muted mb-0">{{ roadmap.current_description }}</p>
                        </div>
                    </div>

                    <!-- Next Levels Roadmap -->
                    {% for next_level in roadmap.next_levels %}
                    <div class="roadmap-level level-{{ next_level.level }}">
                        <div class="d-flex align-items-center mb-3">
                            <div class="progress-step {% if loop.index == 1 %}next{% else %}future{% endif %}">
                                {{ next_level.level }}
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">Level {{ next_level.level }} Advancement</h6>
                                {% if next_level.timeline %}
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ next_level.timeline }}
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <!-- Prerequisites -->
                            <div class="col-md-6 mb-3">
                                <h6 class="fw-bold text-primary">
                                    <i class="bi bi-list-check me-2"></i>Prerequisites
                                </h6>
                                {% if next_level.prerequisites %}
                                    {% for prerequisite in next_level.prerequisites %}
                                    <div class="action-item">
                                        <i class="bi bi-arrow-right me-2 text-primary"></i>
                                        {{ prerequisite }}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No specific prerequisites defined</p>
                                {% endif %}
                            </div>

                            <!-- Action Items -->
                            <div class="col-md-6 mb-3">
                                <h6 class="fw-bold text-success">
                                    <i class="bi bi-gear me-2"></i>Action Items
                                </h6>
                                {% if next_level.action_items %}
                                    {% for action in next_level.action_items %}
                                    <div class="action-item">
                                        <i class="bi bi-play-fill me-2 text-success"></i>
                                        {{ action }}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No specific actions defined</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <!-- Success Metrics -->
                            <div class="col-md-6 mb-3">
                                <h6 class="fw-bold text-warning">
                                    <i class="bi bi-trophy me-2"></i>Success Metrics
                                </h6>
                                {% if next_level.success_metrics %}
                                    {% for metric in next_level.success_metrics %}
                                    <div class="action-item">
                                        <i class="bi bi-check-circle me-2 text-warning"></i>
                                        {{ metric }}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No specific metrics defined</p>
                                {% endif %}
                            </div>

                            <!-- Common Pitfalls -->
                            <div class="col-md-6 mb-3">
                                <h6 class="fw-bold text-danger">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Common Pitfalls
                                </h6>
                                {% if next_level.common_pitfalls %}
                                    {% for pitfall in next_level.common_pitfalls %}
                                    <div class="action-item">
                                        <i class="bi bi-x-circle me-2 text-danger"></i>
                                        {{ pitfall }}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No specific pitfalls identified</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            {% if not roadmap_data %}
            <div class="alert alert-info fade-in">
                <h5 class="alert-heading">
                    <i class="bi bi-info-circle me-2"></i>
                    No Roadmap Available
                </h5>
                <p class="mb-0">
                    Complete more assessment questions to generate a personalized roadmap 
                    for your AI-First maturity journey.
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-5">
        <div class="col-12 text-center fade-in">
            <div class="btn-group no-print" role="group">
                <a href="{{ url_for('assessment.create') }}" 
                   class="btn btn-success btn-lg">
                    <i class="bi bi-plus-circle me-2"></i>New Assessment
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Report script starting...');
    
    try {
        // Animation on scroll
        const animateOnScroll = () => {
            const elements = document.querySelectorAll('.fade-in');
            elements.forEach(element => {
                const elementTop = element.getBoundingClientRect().top;
                const elementVisible = 150;
                
                if (elementTop < window.innerHeight - elementVisible) {
                    element.classList.add('animate');
                }
            });
        };
        
        window.addEventListener('scroll', animateOnScroll);
        animateOnScroll(); // Initial check
        
        // Wait for Chart.js to load with retry mechanism
        function waitForChartJs(retries = 0, maxRetries = 50) {
            if (typeof Chart !== 'undefined') {
                console.log('Chart.js loaded successfully');
                initializeCharts();
            } else if (retries < maxRetries) {
                console.log(`Waiting for Chart.js... (${retries + 1}/${maxRetries})`);
                setTimeout(() => waitForChartJs(retries + 1, maxRetries), 100);
            } else {
                console.error('Chart.js failed to load after', maxRetries, 'attempts');
                // Show error in loading divs
                const sectionLoading = document.getElementById('chartLoadingSection');
                const maturityLoading = document.getElementById('chartLoadingMaturity');
                if (sectionLoading) sectionLoading.innerHTML = '<p class="text-danger">Chart.js not loaded</p>';
                if (maturityLoading) maturityLoading.innerHTML = '<p class="text-danger">Chart.js not loaded</p>';
            }
        }
        
        function initializeCharts() {
            // Get data from backend
            const sectionData = {{ chart_data.section_scores|tojson|safe }};
            const maturityData = {{ chart_data.maturity_distribution|tojson|safe }};
        
        console.log('Section data:', sectionData);
        console.log('Maturity data:', maturityData);
        
        // Section Performance Chart
        const sectionCanvas = document.getElementById('sectionChart');
        const sectionLoadingDiv = document.getElementById('chartLoadingSection');
        if (sectionCanvas && sectionLoadingDiv) {
            try {
                // Destroy existing chart if it exists
                if (window.sectionChartInstance) {
                    window.sectionChartInstance.destroy();
                }
                
                console.log('Section data for assessment {{ assessment.id }}:', sectionData);
                
                if (sectionData && sectionData.length > 0) {
                    const sectionCtx = sectionCanvas.getContext('2d');
                    
                    // Hide loading, show chart
                    sectionLoadingDiv.style.display = 'none';
                    sectionCanvas.style.display = 'block';
                    
                    // Create new chart instance  
                    window.sectionChartInstance = new Chart(sectionCtx, {
                        type: 'doughnut',
                        data: {
                            labels: sectionData.map(s => s.name || 'Unknown'),
                            datasets: [{
                                data: sectionData.map(s => Math.max(0, s.score || 0)),
                                backgroundColor: sectionData.map(s => s.color || '#999999'),
                                borderWidth: 3,
                                borderColor: '#fff',
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 12,
                                        usePointStyle: true,
                                        font: {
                                            size: 10,
                                            weight: 'bold'
                                        },
                                        generateLabels: function(chart) {
                                            const data = chart.data;
                                            if (data.labels.length && data.datasets.length) {
                                                const dataset = data.datasets[0];
                                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                                return data.labels.map((label, i) => {
                                                    const value = dataset.data[i];
                                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                                    // Create more compact labels
                                                    let shortLabel = label;
                                                    if (label.includes('FOUNDATIONAL')) shortLabel = 'Foundation';
                                                    else if (label.includes('TRANSFORMATION')) shortLabel = 'Transformation';
                                                    else if (label.includes('ENTERPRISE')) shortLabel = 'Enterprise';
                                                    else if (label.includes('STRATEGIC')) shortLabel = 'Strategic';
                                                    
                                                    return {
                                                        text: `${shortLabel}: ${value.toFixed(1)} (${percentage}%)`,
                                                        fillStyle: dataset.backgroundColor[i],
                                                        strokeStyle: dataset.backgroundColor[i],
                                                        lineWidth: 0,
                                                        pointStyle: 'circle'
                                                    };
                                                });
                                            }
                                            return [];
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                            return context.label + ': ' + context.parsed.toFixed(1) + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [{
                            id: 'pieLabelPlugin',
                            afterDatasetsDraw: function(chart) {
                                const ctx = chart.ctx;
                                const dataset = chart.data.datasets[0];
                                const meta = chart.getDatasetMeta(0);
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                
                                meta.data.forEach((segment, index) => {
                                    const value = dataset.data[index];
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    
                                    if (percentage >= 8) { // Show labels for segments 8% or larger
                                        const midAngle = segment.startAngle + (segment.endAngle - segment.startAngle) / 2;
                                        const x = segment.x + Math.cos(midAngle) * (segment.outerRadius * 0.6);
                                        const y = segment.y + Math.sin(midAngle) * (segment.outerRadius * 0.6);
                                        
                                        ctx.save();
                                        ctx.fillStyle = '#ffffff';
                                        ctx.font = 'bold 13px Arial';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.strokeStyle = '#000000';
                                        ctx.lineWidth = 2;
                                        
                                        // Add stroke for better readability
                                        ctx.strokeText(value.toFixed(1), x, y - 6);
                                        ctx.fillText(value.toFixed(1), x, y - 6);
                                        
                                        ctx.strokeText(`(${percentage}%)`, x, y + 8);
                                        ctx.fillText(`(${percentage}%)`, x, y + 8);
                                        ctx.restore();
                                    }
                                });
                            }
                        }]
                    });
                } else {
                    sectionLoadingDiv.innerHTML = '<p class="text-muted">No section data available</p>';
                }
            } catch (e) {
                console.error('Error creating section chart:', e);
                sectionLoadingDiv.innerHTML = '<p class="text-danger">Error loading section chart: ' + e.message + '</p>';
            }
        }

        // Maturity Distribution Chart
        const maturityCanvas = document.getElementById('maturityChart');
        const maturityLoadingDiv = document.getElementById('chartLoadingMaturity');
        if (maturityCanvas && maturityLoadingDiv) {
            try {
                // Destroy existing chart if it exists
                if (window.maturityChartInstance) {
                    window.maturityChartInstance.destroy();
                }
                
                const maturityData = {{ chart_data.maturity_distribution|tojson|safe }};
                
                console.log('Maturity data for assessment {{ assessment.id }}:', maturityData);
                
                if (maturityData && Object.keys(maturityData).length > 0) {
                    const maturityCtx = maturityCanvas.getContext('2d');
                    const sectionCount = {{ section_scores|length }} || 4;
                    
                    // Hide loading, show chart
                    maturityLoadingDiv.style.display = 'none';
                    maturityCanvas.style.display = 'block';
                    
                    // Create new chart instance
                    window.maturityChartInstance = new Chart(maturityCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Traditional', 'AI-Assisted', 'AI-Augmented', 'AI-First'],
                            datasets: [{
                                label: 'Number of Sections',
                                data: [
                                    maturityData['Traditional'] || 0,
                                    maturityData['AI-Assisted'] || 0,
                                    maturityData['AI-Augmented'] || 0,
                                    maturityData['AI-First'] || 0
                                ],
                                backgroundColor: [
                                    '#dc3545',  // Traditional - Red
                                    '#ffc107',  // AI-Assisted - Yellow
                                    '#28a745',  // AI-Augmented - Green
                                    '#007bff'   // AI-First - Blue
                                ],
                                borderRadius: 8,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = [
                                                maturityData['Traditional'] || 0,
                                                maturityData['AI-Assisted'] || 0,
                                                maturityData['AI-Augmented'] || 0,
                                                maturityData['AI-First'] || 0
                                            ].reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? Math.round((context.parsed.y / total) * 100) : 0;
                                            const sectionText = context.parsed.y === 1 ? 'section' : 'sections';
                                            return `${context.parsed.y} ${sectionText} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            onHover: (event, activeElements) => {
                                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: Math.max(sectionCount, 4),
                                    ticks: {
                                        stepSize: 1,
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        color: '#f0f0f0'
                                    }
                                },
                                x: {
                                    ticks: {
                                        display: true,
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        maxRotation: 0,
                                        color: '#333333',
                                        padding: 10
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuart'
                            }
                        },
                        plugins: [{
                            id: 'dataLabels',
                            afterDatasetsDraw: function(chart) {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach(function(dataset, i) {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach(function(bar, index) {
                                        const data = dataset.data[index];
                                        
                                        if (data > 0) {
                                            // White text on bar for count with better positioning
                                            ctx.fillStyle = '#ffffff';
                                            ctx.font = 'bold 18px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            ctx.strokeStyle = '#000000';
                                            ctx.lineWidth = 2;
                                            
                                            const position = bar.tooltipPosition();
                                            // Add stroke for better readability
                                            ctx.strokeText(data, position.x, position.y);
                                            ctx.fillText(data, position.x, position.y);
                                        }
                                    });
                                });
                            }
                        }]
                    });
                } else {
                    maturityLoadingDiv.innerHTML = '<p class="text-muted">No maturity data available</p>';
                }
            } catch (e) {
                console.error('Error creating maturity chart:', e);
                maturityLoadingDiv.innerHTML = '<p class="text-danger">Error loading maturity chart: ' + e.message + '</p>';
            }
        }

        // Smooth scrolling for internal links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
        
        console.log('Chart initialization completed successfully');
        } // End of initializeCharts function
        
        // Start the Chart.js loading check
        waitForChartJs();
        
        console.log('Report script completed successfully');
        
    } catch (error) {
        console.error('Error in report script:', error);
        
        // Show error in loading divs
        const sectionLoading = document.getElementById('chartLoadingSection');
        const maturityLoading = document.getElementById('chartLoadingMaturity');
        
        if (sectionLoading) {
            sectionLoading.innerHTML = '<p class="text-danger">Script error: ' + error.message + '</p>';
        }
        if (maturityLoading) {
            maturityLoading.innerHTML = '<p class="text-danger">Script error: ' + error.message + '</p>';
        }
    }
});
</script>
{% endblock %}
