{% extends "base/base.html" %}
{% set page_title = "Assessment Section - " + section.name if section else "Assessment Section" %}

{% block head_extra %}
{% raw %}
<style>
.readonly-section-container {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    padding: 1rem 0;
}

.readonly-section-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}

.readonly-section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    position: relative;
}
</style>
{% endraw %}
{% endblock %}

{% block content %}
<div class="readonly-section-container">
    <div class="container-fluid px-4">
        <div class="row justify-content-center">
            <div class="col-12 col-xxl-11">
                <div class="readonly-section-card">
                    <!-- Header -->
                    <div class="readonly-section-header">
                        <h1 class="mb-2">
                            <i class="{{ section.icon or 'bi bi-gear' }} me-2"></i>
                            {{ section.name }}
                        </h1>
                        <p class="mb-3 opacity-75">{{ section.description }}</p>
                        
                        <!-- Progress -->
                        {% if progress and progress.section_progress %}
                        {% set section_progress = progress.section_progress.get(section.name, {}) %}
                        {% if section_progress %}
                        <div class="section-progress">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-2">Section Progress</h6>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-light" 
                                             data-width="{{ section_progress.get('progress_percentage', 0)|int }}"></div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <div class="h5 mb-0">{{ section_progress.get('responded_questions', 0) }}/{{ section_progress.get('total_questions', 0) }}</div>
                                    <small>Questions Answered</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- Questions Container -->
                    <div class="questions-container p-3 p-lg-4">
                        <!-- Section Summary -->
                        {% if progress and progress.section_progress %}
                        {% set section_progress = progress.section_progress.get(section.name, {}) %}
                        {% if section_progress %}
                        <div class="section-summary mb-4">
                            <h5 class="mb-2">Section Summary</h5>
                            <p>This section covers {{ section.areas|length }} assessment areas.</p>
                            <div class="summary-stats row g-3">
                                <div class="col-6 col-lg-3">
                                    <div class="stat-box text-center p-3 border rounded">
                                        <div class="stat-value h4">{{ section.areas|length }}</div>
                                        <div class="stat-label">Areas</div>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3">
                                    <div class="stat-box text-center p-3 border rounded">
                                        <div class="stat-value h4">{{ section_progress.get('total_questions', 0) }}</div>
                                        <div class="stat-label">Questions</div>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3">
                                    <div class="stat-box text-center p-3 border rounded">
                                        <div class="stat-value h4">{{ section_progress.get('responded_questions', 0) }}</div>
                                        <div class="stat-label">Answered</div>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3">
                                    <div class="stat-box text-center p-3 border rounded">
                                        <div class="stat-value h4">{{ section_progress.get('progress_percentage', 0)|round|int }}%</div>
                                        <div class="stat-label">Complete</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        <!-- Areas and Questions -->
                        {% for area in section.areas %}
                        <div class="area-section mb-4 border rounded">
                            <div class="area-header bg-light p-3">
                                <h4 class="mb-0">{{ area.name }}</h4>
                                {% if area.description %}
                                <p class="text-muted mb-0">{{ area.description }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="questions-list">
                                {% for question in area.questions %}
                                {% set response = responses.get(question.id) %}
                                <div class="question-item p-3 border-bottom">
                                    <div class="question-text h6">{{ question.question }}</div>
                                    
                                    <div class="answer-section mt-2">
                                        <label class="answer-label small fw-bold">Response</label>
                                        {% if response %}
                                        <div class="answer-value p-3 bg-success bg-opacity-10 border border-success rounded">
                                            {% if response.score %}
                                            <div class="fw-bold text-success mb-2">
                                                <i class="bi bi-check-circle me-2"></i>{{ response.get_score_text() }} (Score: {{ response.score }}/4)
                                            </div>
                                            {% if response.score == 1 and question.level_1_desc %}
                                            <div class="level-description bg-white p-2 rounded border-start border-3 border-primary">
                                                <i class="bi bi-quote text-muted me-2"></i>{{ question.level_1_desc }}
                                            </div>
                                            {% elif response.score == 2 and question.level_2_desc %}
                                            <div class="level-description bg-white p-2 rounded border-start border-3 border-primary">
                                                <i class="bi bi-quote text-muted me-2"></i>{{ question.level_2_desc }}
                                            </div>
                                            {% elif response.score == 3 and question.level_3_desc %}
                                            <div class="level-description bg-white p-2 rounded border-start border-3 border-primary">
                                                <i class="bi bi-quote text-muted me-2"></i>{{ question.level_3_desc }}
                                            </div>
                                            {% elif response.score == 4 and question.level_4_desc %}
                                            <div class="level-description bg-white p-2 rounded border-start border-3 border-primary">
                                                <i class="bi bi-quote text-muted me-2"></i>{{ question.level_4_desc }}
                                            </div>
                                            {% endif %}
                                            {% else %}
                                            <em>No answer provided</em>
                                            {% endif %}
                                        </div>
                                        
                                        {% if response.notes %}
                                        <div class="answer-notes p-2 bg-info bg-opacity-10 rounded mt-2">
                                            <strong>Notes:</strong> {{ response.notes }}
                                        </div>
                                        {% endif %}
                                        
                                        {% if response.timestamp %}
                                        <div class="answer-timestamp mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-clock me-1"></i>
                                                Answered on {{ response.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                                            </small>
                                        </div>
                                        {% endif %}
                                        {% else %}
                                        <div class="answer-value p-2 bg-warning bg-opacity-10 rounded">
                                            <em>Not answered</em>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Navigation -->
                    <div class="navigation-section bg-light p-4 text-center">
                        <h4 class="mb-3">Section Navigation</h4>
                        
                        <div class="d-flex gap-3 justify-content-center flex-wrap">
                            <a href="{{ url_for('assessment.view_readonly_sections', assessment_id=assessment.id) }}" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left me-2"></i>
                                Back to Sections
                            </a>
                            
                            <!-- Previous Section -->
                            {% if current_section_index > 0 %}
                            {% set prev_section = all_sections[current_section_index - 1] %}
                            <a href="{{ url_for('assessment.view_readonly_section', assessment_id=assessment.id, section_id=prev_section.id) }}" 
                               class="btn btn-outline-secondary">
                                <i class="bi bi-chevron-left me-2"></i>
                                {{ prev_section.name }}
                            </a>
                            {% endif %}
                            
                            <!-- Next Section -->
                            {% if current_section_index < all_sections|length - 1 %}
                            {% set next_section = all_sections[current_section_index + 1] %}
                            <a href="{{ url_for('assessment.view_readonly_section', assessment_id=assessment.id, section_id=next_section.id) }}" 
                               class="btn btn-primary">
                                {{ next_section.name }}
                                <i class="bi bi-chevron-right ms-2"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
