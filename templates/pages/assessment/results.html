{% extends "base/layout.html" %}
{% set page_title = "Assessment Results" %}
{% set show_breadcrumbs = true %}
{% set breadcrumbs = [
    {"name": "Home", "url": url_for('main.index') if url_for else '/'},
    {"name": "Assessment", "url": url_for('assessment.start') if url_for else '/assessment/start'},
    {"name": "Results", "url": "#", "active": true}
] %}

{% block head_extra %}
{% block extra_css %}
<!-- Assessment styles handled by Bootstrap -->
{% endblock %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="assessment-results-container">
    <!-- Results Header -->
    <div class="results-header bg-gradient-primary text-white py-5 mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="bi bi-trophy me-3"></i>
                        Assessment Results
                    </h1>
                    <p class="lead mb-3">{{ assessment.organization_name }}</p>
                    <div class="d-flex flex-wrap gap-3">
                        <span class="badge bg-light text-primary fs-6 px-3 py-2">
                            <i class="bi bi-calendar me-2"></i>
                            Completed: {{ assessment.completion_date.strftime('%B %d, %Y') }}
                        </span>
                        <span class="badge bg-light text-primary fs-6 px-3 py-2">
                            <i class="bi bi-clock me-2"></i>
                            Duration: {{ assessment_duration }}
                        </span>
                        <span class="badge bg-light text-primary fs-6 px-3 py-2">
                            <i class="bi bi-check-circle me-2"></i>
                            {{ total_questions }} Questions Completed
                        </span>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="overall-score-display">
                        <div class="score-circle-xl bg-white text-primary mx-auto mb-3" 
                             style="width: 150px; height: 150px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div class="text-center">
                                <div class="fw-bold" style="font-size: 3rem;">{{ "%.1f"|format(assessment.overall_score) }}</div>
                                <div class="fw-semibold">AFS Score</div>
                            </div>
                        </div>
                        <h4 class="fw-bold">{{ assessment.maturity_level }}</h4>
                        <p class="mb-0">Maturity Level</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-3">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">Share and Export Your Results</h6>
                                <p class="text-muted mb-0 small">Download reports, share insights, or start a new assessment</p>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2 justify-content-md-end">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="shareBtn">
                                        <i class="bi bi-share me-1"></i>Share
                                    </button>
                                    <!-- Export functionality removed -->
                                    <div class="text-muted">
                                        <small><i class="bi bi-info-circle me-1"></i>Assessment completed successfully</small>
                                    </div>
                                    <a href="{{ url_for('assessment.start') if url_for else '/assessment/start' }}" 
                                       class="btn btn-success btn-sm">
                                        <i class="bi bi-plus-circle me-1"></i>New Assessment
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AFS Score Breakdown -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            AFS Score Breakdown
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <canvas id="scoreBreakdownChart" width="300" height="300"></canvas>
                            </div>
                            <div class="col-md-6">
                                <div class="score-legend">
                                    {% for section in section_scores %}
                                    <div class="legend-item d-flex justify-content-between align-items-center mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="legend-color me-3" 
                                                 style="width: 16px; height: 16px; background-color: {{ section.color }}; border-radius: 50%;"></div>
                                            <div>
                                                <h6 class="mb-0">{{ section.name }}</h6>
                                                <small class="text-muted">{{ section.question_count }} questions</small>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold">{{ "%.1f"|format(section.score) }}</div>
                                            <small class="text-muted">{{ section.percentage }}%</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Score Analysis -->
                        <div class="score-analysis mt-4 pt-4 border-top">
                            <h6>Score Analysis</h6>
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <div class="analysis-metric">
                                        <div class="fw-bold fs-4 text-success">{{ strongest_section.name }}</div>
                                        <div class="text-muted">Strongest Area</div>
                                        <div class="badge bg-success mt-1">{{ "%.1f"|format(strongest_section.score) }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="analysis-metric">
                                        <div class="fw-bold fs-4 text-warning">{{ improvement_section.name }}</div>
                                        <div class="text-muted">Priority for Improvement</div>
                                        <div class="badge bg-warning text-dark mt-1">{{ "%.1f"|format(improvement_section.score) }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="analysis-metric">
                                        <div class="fw-bold fs-4 text-info">{{ score_variance }}</div>
                                        <div class="text-muted">Score Consistency</div>
                                        <div class="badge bg-info mt-1">{{ consistency_level }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Maturity Level Card -->
                <div class="card mb-4">
                    <div class="card-header bg-{{ maturity_color }} text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-award me-2"></i>
                            Maturity Level
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <h3 class="text-{{ maturity_color }} mb-3">{{ assessment.maturity_level }}</h3>
                        <p class="mb-3">{{ maturity_description }}</p>
                        
                        <!-- Maturity Progress -->
                        <div class="maturity-progress mb-3">
                            <div class="row text-center small">
                                {% for level in maturity_levels %}
                                <div class="col">
                                    <div class="maturity-step {{ 'active' if level.name == assessment.maturity_level else '' }} {{ 'completed' if level.order < current_maturity_order else '' }}">
                                        <div class="step-circle mb-1">{{ level.order }}</div>
                                        <div class="step-label">{{ level.name[:8] }}...</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if next_maturity_level %}
                        <div class="next-level-info p-3 bg-light rounded">
                            <h6 class="mb-2">Next Level: {{ next_maturity_level.name }}</h6>
                            <p class="small text-muted mb-2">{{ next_maturity_level.description }}</p>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ progress_to_next_level }}%" 
                                     aria-valuenow="{{ progress_to_next_level }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">{{ progress_to_next_level }}% to next level</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart me-2"></i>
                            Key Metrics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="metric-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Questions Answered</span>
                                <span class="fw-bold">{{ total_questions }}</span>
                            </div>
                        </div>
                        <div class="metric-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Average Response Time</span>
                                <span class="fw-bold">{{ avg_response_time }}</span>
                            </div>
                        </div>
                        <div class="metric-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Highest Section Score</span>
                                <span class="fw-bold text-success">{{ "%.1f"|format(highest_section_score) }}</span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Lowest Section Score</span>
                                <span class="fw-bold text-warning">{{ "%.1f"|format(lowest_section_score) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Results -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-list-check me-2"></i>
                            Detailed Section Results
                        </h4>
                    </div>
                    <div class="card-body">
                        {% for section in detailed_section_results %}
                        <div class="section-result mb-4 {% if not loop.last %}border-bottom pb-4{% endif %}">
                            <div class="row align-items-center mb-3">
                                <div class="col-md-8">
                                    <h5 class="mb-1">
                                        <i class="bi bi-{{ section.icon }} me-2 text-{{ section.color }}"></i>
                                        {{ section.name }}
                                    </h5>
                                    <p class="text-muted mb-0">{{ section.description }}</p>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <div class="section-score-display">
                                        <div class="fw-bold fs-3 text-{{ section.color }}">{{ "%.1f"|format(section.score) }}</div>
                                        <div class="text-muted">Section Score</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Area Breakdown -->
                                    <h6 class="mb-3">Area Breakdown</h6>
                                    {% for area in section.areas %}
                                    <div class="area-result mb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>{{ area.name }}</span>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-3" style="width: 100px; height: 8px;">
                                                    <div class="progress-bar bg-{{ section.color }}" role="progressbar" 
                                                         style="width: {{ (area.score / 4 * 100) }}%">
                                                    </div>
                                                </div>
                                                <span class="badge bg-{{ section.color }}">{{ "%.1f"|format(area.score) }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Section Insights -->
                                    <h6 class="mb-3">Key Insights</h6>
                                    <ul class="list-unstyled insights-list">
                                        {% for insight in section.insights %}
                                        <li class="mb-2">
                                            <i class="bi bi-{{ insight.icon }} text-{{ insight.type }} me-2"></i>
                                            <span class="small">{{ insight.text }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-lightbulb me-2"></i>
                            Personalized Recommendations
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for recommendation in recommendations %}
                            <div class="col-md-6 mb-4">
                                <div class="recommendation-card h-100 border rounded-3 p-3">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="recommendation-priority bg-{{ recommendation.priority_color }} text-white rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <span class="fw-bold">{{ recommendation.priority_order }}</span>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ recommendation.title }}</h6>
                                            <span class="badge badge-{{ recommendation.type.lower() }}">{{ recommendation.type }}</span>
                                        </div>
                                    </div>
                                    
                                    <p class="text-muted mb-3">{{ recommendation.description }}</p>
                                    
                                    <div class="recommendation-details">
                                        <div class="row text-center mb-3">
                                            <div class="col-4">
                                                <div class="fw-bold text-success">{{ recommendation.impact }}</div>
                                                <div class="small text-muted">Impact</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-info">{{ recommendation.effort }}</div>
                                                <div class="small text-muted">Effort</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-primary">{{ recommendation.timeline }}</div>
                                                <div class="small text-muted">Timeline</div>
                                            </div>
                                        </div>
                                        
                                        {% if recommendation.resources %}
                                        <div class="recommendation-resources">
                                            <h6 class="small fw-bold mb-2">Recommended Resources:</h6>
                                            <ul class="list-unstyled small">
                                                {% for resource in recommendation.resources %}
                                                <li class="mb-1">
                                                    <a href="{{ resource.url }}" target="_blank" class="text-decoration-none">
                                                        <i class="bi bi-link-45deg me-1"></i>{{ resource.title }}
                                                    </a>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison with Previous Assessments -->
        {% if previous_assessments %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-graph-up-arrow me-2"></i>
                            Progress Over Time
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="progressChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-4">
                                <h6>Progress Summary</h6>
                                <div class="progress-summary">
                                    {% for comparison in assessment_comparisons %}
                                    <div class="comparison-item mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="small">{{ comparison.section }}</span>
                                            <div class="d-flex align-items-center">
                                                {% if comparison.change > 0 %}
                                                    <i class="bi bi-arrow-up text-success me-1"></i>
                                                    <span class="text-success fw-bold">+{{ "%.1f"|format(comparison.change) }}</span>
                                                {% elif comparison.change < 0 %}
                                                    <i class="bi bi-arrow-down text-danger me-1"></i>
                                                    <span class="text-danger fw-bold">{{ "%.1f"|format(comparison.change) }}</span>
                                                {% else %}
                                                    <i class="bi bi-dash text-muted me-1"></i>
                                                    <span class="text-muted fw-bold">0.0</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Next Steps -->
        <div class="row">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-arrow-right-circle me-2"></i>
                            Next Steps
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Recommended Actions</h5>
                                <ol class="next-steps-list">
                                    {% for step in next_steps %}
                                    <li class="mb-2">
                                        <strong>{{ step.title }}:</strong> {{ step.description }}
                                        {% if step.timeline %}
                                        <span class="badge bg-light text-dark ms-2">{{ step.timeline }}</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ol>
                            </div>
                            <div class="col-md-4">
                                <h5>Resources & Support</h5>
                                <div class="d-grid gap-2">
                                    <a href="/resources" 
                                       class="btn btn-outline-primary">
                                        <i class="bi bi-book me-2"></i>Resource Library
                                    </a>
                                    <a href="/contact" 
                                       class="btn btn-outline-info">
                                        <i class="bi bi-envelope me-2"></i>Get Expert Help
                                    </a>
                                    <a href="{{ url_for('assessment.start') if url_for else '/assessment/start' }}" 
                                       class="btn btn-success">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Retake Assessment
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Assessment Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareUrl" class="form-label">Public Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shareUrl" readonly 
                               value="{{ request.url_root }}assessment/{{ assessment.id }}/public">
                        <button class="btn btn-outline-secondary" type="button" id="copyUrlBtn">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <div class="form-text">Anyone with this link can view your assessment results</div>
                </div>
                
                <div class="share-options">
                    <h6>Share via</h6>
                    <div class="d-grid gap-2">
                        <a href="mailto:?subject=Assessment Results&body=Check out my AI-First Software Engineering Maturity Assessment results: {{ request.url_root }}assessment/{{ assessment.id }}/public" 
                           class="btn btn-outline-primary">
                            <i class="bi bi-envelope me-2"></i>Email
                        </a>
                        <a href="https://linkedin.com/sharing/share-offsite/?url={{ request.url_root }}assessment/{{ assessment.id }}/public" 
                           target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-linkedin me-2"></i>LinkedIn
                        </a>
                        <a href="https://twitter.com/intent/tweet?url={{ request.url_root }}assessment/{{ assessment.id }}/public&text=Check out my AI-First Software Engineering Maturity Assessment results!" 
                           target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-twitter me-2"></i>Twitter
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Score Breakdown Chart
    const scoreCtx = document.getElementById('scoreBreakdownChart').getContext('2d');
    new Chart(scoreCtx, {
        type: 'doughnut',
        data: {
            labels: {{ section_names|tojson }},
            datasets: [{
                data: {{ section_scores_data|tojson }},
                backgroundColor: {{ section_colors|tojson }},
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Progress Chart (if previous assessments exist)
    {% if previous_assessments %}
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    new Chart(progressCtx, {
        type: 'line',
        data: {
            labels: {{ assessment_dates|tojson }},
            datasets: [{
                label: 'Overall AFS Score',
                data: {{ historical_scores|tojson }},
                borderColor: '#0066cc',
                backgroundColor: 'rgba(0, 102, 204, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 4.0,
                    ticks: {
                        stepSize: 0.5
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    {% endif %}
    
    // Share functionality
    document.getElementById('shareBtn').addEventListener('click', function() {
        const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
        shareModal.show();
    });
    
    document.getElementById('copyUrlBtn').addEventListener('click', function() {
        const shareUrl = document.getElementById('shareUrl');
        shareUrl.select();
        document.execCommand('copy');
        
        // Show success feedback
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="bi bi-check"></i>';
        this.classList.add('btn-success');
        this.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-secondary');
        }, 2000);
    });
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        // Check if tooltip is already initialized
        if (!tooltipTriggerEl.hasAttribute('data-tooltip-initialized')) {
            const tooltip = new bootstrap.Tooltip(tooltipTriggerEl);
            tooltipTriggerEl.setAttribute('data-tooltip-initialized', 'true');
            return tooltip;
        }
    });
    
    // Animate elements on scroll
    const animateOnScroll = () => {
        const elements = document.querySelectorAll('.fade-in, .slide-up');
        elements.forEach(element => {
            const elementTop = element.getBoundingClientRect().top;
            const elementVisible = 150;
            
            if (elementTop < window.innerHeight - elementVisible) {
                element.classList.add('animate');
            }
        });
    };
    
    window.addEventListener('scroll', animateOnScroll);
    animateOnScroll(); // Initial check
});
</script>
{% endblock %}
